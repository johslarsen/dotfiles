#!/usr/bin/env python3
from collections import defaultdict
import csv
from datetime import datetime
import sys
import matplotlib.pyplot as plt
import re

DATE_LIKE = re.compile("[0-9]{4}-[0-9]{2}-[0-9]{2}")


def guess_type(field):
    if DATE_LIKE.match(field):
        fmt = f"%Y-%m-%d{"T" if "T" in field else " "}%H:%M:%S"
        if "." in field:
            fmt += ".%f"
        return datetime.strptime(field[0:26], fmt)
    if field.startswith("0x") or field.startswith("0X"):
        return int(field, 16)
    return float(field)


legend = []
for path in sys.argv[1:]:
    with open(path) as file:
        cols = None
        for row in csv.reader(file):
            if cols is None:
                cols = [[] for i in range(0, len(row))]
                if row[0][0] == '#':
                    prefix = "" if path.startswith("/dev/fd/") else f"{path}:"
                    legend += [f"{prefix}{row[i]}" for i in range(1, len(row))]
                    continue
                legend += [f"{path}:{i}" for i in range(1, len(row))]
            cols[0].append(guess_type(row[0]))
            for i, value in enumerate(row[1:]):
                cols[1 + i].append(guess_type(value))
        for col in cols[1:]:
            plt.plot(cols[0], col)
plt.legend(legend)
plt.show()
