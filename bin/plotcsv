#!/usr/bin/env python3
from collections import defaultdict
import csv
from datetime import datetime
import os
import sys
import matplotlib.pyplot as plt
import re

DATE_LIKE = re.compile("[0-9]{4}-[0-9]{2}-[0-9]{2}")
TIME_LIKE = re.compile("[0-9]{2}:[0-9]{2}:[0-9]{2}")
TZ_LIKE = re.compile("Z|[+-][0-9]{4}")

def guess_type(field):
    fmt = "%Y-%m-%d" if DATE_LIKE.match(field) else ""
    if TIME_LIKE.search(field):
        if fmt != "":
            fmt += "T" if "T" in field else " "
        fmt += "%H:%M:%S"
        if "." in field:
            fmt += ".%f"
        if "Z" in field:
            fmt += "Z"
        elif TZ_LIKE.search(field):
            fmt += "%z"
    if fmt != "":
        return datetime.strptime(field, fmt)
    if field.startswith("0x") or field.startswith("0X"):
        return int(field, 16)
    if field == "":
        return 0
    return float(field)

legend = []
for path in sys.argv[1:]:
    with open(path) as file:
        cols = None
        for row in csv.reader(file):
            if cols is None:
                cols = [[] for i in range(0, len(row))]
                prefix = "" if path.startswith("/dev/fd/") else f"{path}:"
                legend += [f"{prefix}{row[i]}" for i in range(1, len(row))]
                continue
            cols[0].append(guess_type(row[0]))
            for i, value in enumerate(row[1:]):
                cols[1 + i].append(guess_type(value))
        for col in cols[1:]:
            plt.plot(cols[0], col, os.getenv("PLOTFMT", ""))
plt.legend(legend)
plt.show()
